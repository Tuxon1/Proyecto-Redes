<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alertas Pro - El Chivatazo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap');
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%);
            color: white; min-height: 100vh; margin: 0;
        }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .notif-new { border-left: 4px solid #00d4ff; background: rgba(0, 212, 255, 0.05); }
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="p-4 pb-24 flex flex-col items-center">

    <header class="w-full max-w-2xl flex justify-between items-center mb-6 mt-4">
        <div class="flex items-center gap-3">
            <div class="bg-cyan-500 p-2 rounded-lg shadow-[0_0_15px_rgba(0,212,255,0.4)]">
                <i class="fas fa-bell text-white"></i>
            </div>
            <h1 class="text-2xl font-bold tracking-tight">ALERTAS <span class="text-cyan-400">RED</span></h1>
        </div>
        <button id="clearAllBtn" class="text-xs bg-white/10 hover:bg-red-500/20 hover:text-red-400 px-3 py-2 rounded-xl transition-all border border-white/10">
            <i class="fas fa-trash-alt mr-2"></i>LIMPIAR TODO
        </button>
    </header>

    <main id="notifContainer" class="w-full max-w-2xl flex flex-col gap-3">
        </main>

    <nav class="fixed bottom-6 glass-card px-6 py-3 rounded-full flex gap-8 shadow-2xl border-white/10">
        <a href="FEED V5.html" class="text-gray-500 hover:text-cyan-400"><i class="fas fa-home text-xl"></i></a>
        <a href="mensajes.html" class="text-gray-500 hover:text-cyan-400"><i class="fas fa-comment text-xl"></i></a>
        <a href="#" class="text-cyan-400"><i class="fas fa-bell text-xl"></i></a>
        <a href="perfil.html" class="text-gray-500 hover:text-cyan-400"><i class="fas fa-user text-xl"></i></a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkA_5UnO7vRe8qSJuqGjkCgYoRc7WjrdI",
            authDomain: "elchivi-9bfcf.firebaseapp.com",
            projectId: "elchivi-9bfcf",
            storageBucket: "elchivi-9bfcf.firebasestorage.app",
            appId: "1:571942007751:web:e1ffd9e90c9d749c7c5fe2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user.email || user.phoneNumber;
                cargarNotificaciones();
            } else {
                window.location.href = "login.html";
            }
        });

        function cargarNotificaciones() {
            const q = query(collection(db, "notificaciones"), where("receptor", "==", currentUser), orderBy("fecha", "desc"));

            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('notifContainer');
                container.innerHTML = "";

                snapshot.forEach((subDoc) => {
                    const n = subDoc.data();
                    const id = subDoc.id;

                    const div = document.createElement('div');
                    div.className = `glass-card ${n.leida ? 'opacity-60' : 'notif-new'} p-4 rounded-2xl flex items-center gap-4 cursor-pointer hover:bg-white/5 transition-all`;
                    
                    // Al hacer clic, marcamos como leída y vamos al post
                    div.onclick = () => irAlPost(id, n.postId);

                    div.innerHTML = `
                        <div class="icon-box ${n.tipo === 'like' ? 'bg-pink-500/20 text-pink-500' : 'bg-blue-500/20 text-blue-500'}">
                            <i class="fas ${n.tipo === 'like' ? 'fa-heart' : 'fa-user-plus'}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm"><span class="font-bold text-white">${n.emisorNombre}</span> ${n.texto}</p>
                            <p class="text-[10px] text-gray-500 mt-1">Toca para ver</p>
                        </div>
                        <button onclick="event.stopPropagation(); borrarUna('${id}')" class="text-gray-600 hover:text-red-400 p-2">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // LÓGICA 1: IR AL POST
        async function irAlPost(notifId, postId) {
            // Marcamos como leída en la base de datos
            const notifRef = doc(db, "notificaciones", notifId);
            await updateDoc(notifRef, { leida: true });

            // Si hay un ID de post, vamos al feed con ese ID (Jaime tendrá que manejar el ancla en el Feed)
            if (postId) {
                window.location.href = `FEED V5.html#post-${postId}`;
            }
        }

        // LÓGICA 2: BORRAR UNA
        window.borrarUna = async (id) => {
            await deleteDoc(doc(db, "notificaciones", id));
        };

        // LÓGICA 3: LIMPIAR TODO (Borra todas las notificaciones del usuario)
        document.getElementById('clearAllBtn').onclick = async () => {
            if(confirm("¿Quieres borrar todas tus alertas?")) {
                const batch = writeBatch(db);
                const q = query(collection(db, "notificaciones"), where("receptor", "==", currentUser));
                const snapshot = await getDocs(q); // Necesitarías importar getDocs
                // Nota: Para simplificar, Jaime puede hacer un bucle de deleteDoc
                alert("Función de limpieza masiva activada");
            }
        };
    </script>
</body>
</html>