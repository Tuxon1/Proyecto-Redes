<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Zona Mixta Period√≠stica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fusionamos las fuentes y el fondo oscuro */
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap');

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
        }

        /* Efecto Cristal para tu tarjeta central */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        /* Colores personalizados */
        .text-cyan-glow {
            color: #00d4ff;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.4);
        }

        .bg-cyan-custom {
            background-color: #00d4ff;
            color: #1a1a2e;
        }

        .bg-cyan-custom:hover {
            background-color: #0099cc;
        }

        [contenteditable]:focus {
            outline: 2px solid #00d4ff;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 0 4px;
        }

        /* CONFIGURACI√ìN DE LAS ZONAS DE IMAGEN */
        .upload-zone {
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        /* Clases que SOLO funcionan cuando el modo edici√≥n est√° activo */
        .edit-mode-active .upload-zone {
            cursor: pointer;
        }

        .edit-mode-active .upload-zone:hover::after {
            content: "CAMBIAR IMAGEN üì∑";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00d4ff;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* Estilo visual para campos editables */
        .edit-mode-active [contenteditable="true"] {
            background: rgba(0, 212, 255, 0.05);
            border-bottom: 1px dashed #00d4ff;
            padding-bottom: 2px;
            outline: none;
        }

        /* Avatar circular con el dise√±o propuesto */
        .avatar-container {
            border: 3px solid #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
            background-color: #1a1a2e;
        }

        /* --- ESTILOS DEL MODAL DE NO VERIFICADO --- */
        .warning-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #ffcc00;
            animation: pulse-warning 1.5s infinite;
            text-shadow: 0 0 20px rgba(255, 204, 0, 0.4);
        }

        @keyframes pulse-warning {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .btn-return {
            background: transparent;
            border: 1px solid #ffcc00;
            color: #ffcc00;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 15px;
        }

        .btn-return:hover {
            background: #ffcc00;
            color: #1a1a2e;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 25, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-overlay input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00d4ff;
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            outline: none;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-8 h-full">

        <aside class="md:w-64 space-y-4">
            <div class="text-3xl font-black italic text-cyan-glow mb-10 tracking-tighter uppercase mt-2">El Chivatazo
            </div>
            <nav class="space-y-3 font-bold text-sm">
                <div class="p-3 bg-cyan-custom rounded-lg cursor-pointer flex items-center gap-2">üìª Al Aire</div>
            </nav>
        </aside>

        <main class="flex-1">
            <div class="glass-card rounded-2xl overflow-hidden relative">

                <div class="absolute top-4 right-4 z-50">
                    <button id="menuToggle"
                        class="text-white hover:text-[#00d4ff] transition p-2 rounded-full hover:bg-black/30 backdrop-blur-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    </button>

                    <div id="dropdownMenu"
                        class="hidden absolute right-0 mt-2 w-48 bg-[#1a1a2e] border border-[#00d4ff]/30 rounded-xl shadow-2xl overflow-hidden">
                        
                        <div id="editProfileBtn"
                            class="px-4 py-3 text-[#00d4ff] hover:bg-[#00d4ff]/10 cursor-pointer transition font-bold flex items-center gap-2 border-b border-[#00d4ff]/20">
                            ‚úèÔ∏è Editar Perfil
                        </div>

                        <div id="logoutBtn"
                            class="px-4 py-3 text-red-400 hover:bg-red-500/10 hover:text-red-300 cursor-pointer transition font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Cerrar Sesi√≥n
                        </div>
                    </div>
                </div>

                <div id="headerUploadZone" class="upload-zone h-60 bg-slate-800">
                    <img id="header-img" class="w-full h-full object-cover opacity-70"
                        src="https://images.unsplash.com/photo-1508098682722-e99c43a406b2?q=80&w=1470&auto=format&fit=crop">
                    <input type="file" id="input-header" class="hidden" accept="image/*"
                        onchange="updateImg(this, 'header-img')">
                </div>

                <div class="px-8 pb-8 relative">
                    <div class="flex justify-between items-end -mt-16 mb-4">
                        
                        <div id="avatarUploadZone" class="upload-zone w-32 h-32 rounded-full avatar-container">
                            <img id="userPhoto" class="w-full h-full object-cover rounded-full"
                                src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                            <input type="file" id="input-avatar" class="hidden" accept="image/*"
                                onchange="updateImg(this, 'userPhoto')">
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="saveProfileBtn"
                                class="hidden bg-green-500 px-6 py-2 rounded-lg font-bold transition mb-2 shadow-lg hover:-translate-y-1 text-white">
                                üíæ Guardar
                            </button>
                            <button
                                class="bg-cyan-custom px-6 py-2 rounded-lg font-bold transition mb-2 shadow-lg hover:-translate-y-1 text-[#1a1a2e]">
                                Publicar Primicia
                            </button>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <div class="flex items-center gap-3">
                            <h1 id="userName" class="text-3xl font-black tracking-tight transition-all">Cargando...</h1>
                            <span
                                class="bg-[#00d4ff]/20 text-[#00d4ff] border border-[#00d4ff]/50 text-xs font-bold px-2 py-0.5 rounded italic uppercase">Prensa
                                Verificada</span>
                        </div>

                        <p id="userEmail" class="text-slate-400 text-sm">cargando@correo.com</p>

                        <p id="userMedia" class="text-[#00d4ff] font-bold text-lg pt-3 uppercase tracking-wide transition-all">Buscando
                            credenciales...</p>

                        <p id="userBio" class="max-w-2xl text-slate-300 leading-relaxed pt-2 transition-all">
                            Tu biograf√≠a profesional o especialidad t√°ctica aparecer√° aqu√≠. Haz clic en "Editar Perfil" en el men√∫ para cambiarla.
                        </p>
                    </div>

                    <div class="flex gap-12 mt-8 border-t border-white/10 pt-6 font-black">
                        <div>
                            <p class="text-3xl text-cyan-glow">1.2K</p>
                            <p class="text-slate-400 text-[10px] uppercase tracking-widest mt-1">Lectores</p>
                        </div>
                        <div>
                            <p class="text-3xl text-cyan-glow">45</p>
                            <p class="text-slate-400 text-[10px] uppercase tracking-widest mt-1">Primicias</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="logoutModal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-[#1a1a2e]/80 backdrop-blur-sm transition-opacity">
        <div
            class="glass-card rounded-2xl p-8 max-w-sm w-full mx-4 text-center border border-[#00d4ff]/30 shadow-[0_0_40px_rgba(0,212,255,0.15)]">

            <div
                class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-500/10 mb-6 border border-red-500/20">
                <svg class="h-8 w-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </div>

            <h3 class="text-xl font-black text-white mb-2 tracking-wide">¬øAbandonar la zona mixta?</h3>
            <p class="text-slate-300 text-sm mb-8">¬øEst√°s seguro de que quieres cerrar tu sesi√≥n actual?</p>

            <div class="flex justify-between gap-4">
                <button id="cancelLogoutBtn"
                    class="flex-1 py-3 rounded-lg font-bold border border-white/20 text-slate-300 hover:bg-white/10 hover:text-white transition">
                    Cancelar
                </button>
                <button id="confirmLogoutBtn"
                    class="flex-1 py-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 shadow-[0_0_15px_rgba(239,68,68,0.4)] transition">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="verificationModal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-[#1a1a2e]/90 backdrop-blur-md">
        <div
            class="glass-card rounded-2xl p-8 max-w-sm w-full mx-4 text-center border border-[#ffcc00]/30 shadow-[0_0_40px_rgba(255,204,0,0.1)]">

            <div class="warning-icon">‚ö†Ô∏è</div>

            <h2 class="text-xl font-black text-[#ffcc00] mb-3 tracking-wide uppercase">ACCESO RESTRINGIDO</h2>

            <p class="text-slate-300 text-sm mb-6 leading-relaxed">
                Tu cuenta a√∫n no ha sido verificada.<br><br>
                Por favor, revisa tu bandeja de entrada (y la carpeta de <strong>SPAM</strong>) para activar tu pase de
                prensa.
            </p>

            <button id="btnBackToLogin" class="btn-return">
                Vuelvo ahora
            </button>
        </div>
    </div>

    <div id="resetPasswordModal"
        class="modal-overlay hidden fixed inset-0 z-[100] flex items-center justify-center bg-[#1a1a2e]/90 backdrop-blur-md">
        <div
            class="glass-card rounded-2xl p-8 max-w-sm w-full mx-4 text-center border border-[#00d4ff]/30 shadow-[0_0_40px_rgba(0,212,255,0.15)]">

            <div
                class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-[#00d4ff]/10 mb-6 border border-[#00d4ff]/20">
                <svg class="h-8 w-8 text-[#00d4ff]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>

            <h3 class="text-xl font-black text-white mb-2 tracking-wide uppercase">Nueva Seguridad</h3>
            <p class="text-slate-300 text-sm mb-6">Has entrado v√≠a SMS. Define una contrase√±a para tus pr√≥ximos accesos.
            </p>

            <div class="space-y-4 mb-8">
                <input type="password" id="newPasswordInput" placeholder="M√≠nimo 6 caracteres"
                    class="w-full bg-black/30 border border-[#00d4ff]/30 rounded-lg p-3 text-white text-center focus:outline-none focus:border-[#00d4ff] transition">
            </div>

            <button id="btnSaveNewPassword"
                class="w-full py-3 rounded-lg font-bold bg-cyan-custom text-[#1a1a2e] hover:shadow-[0_0_20px_rgba(0,212,255,0.4)] transition uppercase tracking-tighter">
                Actualizar Contrase√±a
            </button>
        </div>
    </div>

    <div id="successPassModal"
        class="modal-overlay hidden fixed inset-0 z-[100] flex items-center justify-center bg-[#1a1a2e]/90 backdrop-blur-md">
        <div
            class="glass-card rounded-2xl p-8 max-w-sm w-full mx-4 text-center border border-[#00d4ff]/30 shadow-[0_0_40px_rgba(0,212,255,0.15)]">

            <div class="text-6xl mb-6 drop-shadow-[0_0_15px_rgba(0,212,255,0.5)]">‚≠ê</div>

            <h3 class="text-2xl font-black text-[#00d4ff] mb-2 tracking-wide uppercase">¬°Todo Listo!</h3>
            <p class="text-slate-300 text-sm mb-8">Tu contrase√±a ha sido actualizada. Ya puedes operar con normalidad en
                la zona mixta.</p>

            <button id="btnFinishSuccess"
                class="w-full py-3 rounded-lg font-bold bg-cyan-custom text-[#1a1a2e] hover:shadow-[0_0_20px_rgba(0,212,255,0.4)] transition uppercase">
                Entrar al Perfil
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, EmailAuthProvider, linkWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // IMPORTANTE: ¬°Hemos a√±adido updateDoc aqu√≠!
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkA_5UnO7vRe8qSJuqGjkCgYoRc7WjrdI",
            authDomain: "elchivi-9bfcf.firebaseapp.com",
            projectId: "elchivi-9bfcf",
            storageBucket: "elchivi-9bfcf.firebasestorage.app",
            messagingSenderId: "571942007751",
            appId: "1:571942007751:web:e1ffd9e90c9d749c7c5fe2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias HTML
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userMedia = document.getElementById('userMedia');
        const userPhoto = document.getElementById('userPhoto');
        const userBio = document.getElementById('userBio');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Filtros de Seguridad y Validaciones (No Verificado, Expirado, Pass por SMS...)
                const esUsuarioTelefono = user.phoneNumber !== null;
                const esEmailVerificado = user.emailVerified === true;

                if (!esUsuarioTelefono && !esEmailVerificado) {
                    const fechaCreacion = new Date(user.metadata.creationTime).getTime();
                    const ahora = new Date().getTime();
                    const sieteDiasEnMs = 7 * 24 * 60 * 60 * 1000;

                    if (ahora - fechaCreacion > sieteDiasEnMs) {
                        try {
                            await user.delete();
                            alert("‚åõ TPO. AGOTADO\n\nTu solicitud de registro ha caducado.\nLa cuenta ha sido eliminada por seguridad.");
                            window.location.href = "registro.html";
                        } catch (error) {
                            console.error("Error al borrar:", error);
                            await signOut(auth);
                            window.location.href = "login.html";
                        }
                        return;
                    }

                    const verifyModal = document.getElementById('verificationModal');
                    verifyModal.classList.remove('hidden');

                    document.getElementById('btnBackToLogin').addEventListener('click', async () => {
                        await signOut(auth);
                        window.location.href = "login.html";
                    });

                    return;
                }

                const entroConSMS = user.providerData.some(p => p.providerId === 'phone');
                const yaCambiado = sessionStorage.getItem('passwordCambiado');

                if (entroConSMS && !yaCambiado) {
                    const resetModal = document.getElementById('resetPasswordModal');
                    const successModal = document.getElementById('successPassModal');

                    if (resetModal) {
                        resetModal.classList.remove('hidden');
                        resetModal.classList.add('flex');

                        document.getElementById('btnSaveNewPassword').onclick = async () => {
                            const newPass = document.getElementById('newPasswordInput').value;
                            if (newPass.length < 6) { alert("La contrase√±a debe ser de al menos 6 caracteres"); return; }

                            try {
                                await updatePassword(user, newPass);
                                sessionStorage.setItem('passwordCambiado', 'true');

                                resetModal.classList.add('hidden');
                                successModal.classList.remove('hidden');
                                successModal.classList.add('flex');

                                document.getElementById('btnFinishSuccess').onclick = () => {
                                    successModal.classList.add('hidden');
                                };
                            } catch (error) {
                                alert("Error: " + error.message);
                            }
                        };
                    }
                }

                // Carga de Datos B√°sicos
                userEmail.textContent = user.email;

                if (user.displayName) userName.textContent = user.displayName;
                if (user.photoURL) userPhoto.src = user.photoURL.replace("=s96-c", "=s400-c");

                // Buscar datos extra en Firestore (Nombre, Medio y Biograf√≠a)
                try {
                    const docRef = doc(db, "periodistas", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const datos = docSnap.data();
                        userName.textContent = datos.nombreCompleto || userName.textContent;
                        userMedia.textContent = datos.medioComunicacion || "Freelance";
                        
                        // A√±adida la carga de la Biograf√≠a
                        if (datos.biografia) {
                            userBio.textContent = datos.biografia;
                        }
                    } else {
                        userMedia.textContent = "Sin medio asignado";
                    }
                } catch (error) {
                    console.error("Error Firestore:", error);
                }
            } else {
                window.location.href = "login.html";
            }
        });


        // ==========================================
        // --- NUEVA L√ìGICA DE EDICI√ìN DE PERFIL ---
        // ==========================================
        let isEditMode = false;
        
        const editProfileBtn = document.getElementById('editProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const headerUploadZone = document.getElementById('headerUploadZone');
        const avatarUploadZone = document.getElementById('avatarUploadZone');

        // 1. Activar Modo Edici√≥n
        editProfileBtn.addEventListener('click', () => {
            isEditMode = true;
            document.body.classList.add('edit-mode-active');
            
            // Habilitamos los textos para escribirlos
            userName.contentEditable = "true";
            userMedia.contentEditable = "true";
            userBio.contentEditable = "true";
            
            // Mostrar bot√≥n Guardar
            saveProfileBtn.classList.remove('hidden');
            
            // Ocultar el men√∫ desplegable
            document.getElementById('dropdownMenu').classList.add('hidden');
            
            // Ponemos el cursor en el nombre autom√°ticamente
            userName.focus(); 
        });

        // 2. Controlar clics en las fotos (solo se abren si estamos en modo edici√≥n)
        headerUploadZone.addEventListener('click', () => {
            if(isEditMode) document.getElementById('input-header').click();
        });
        
        avatarUploadZone.addEventListener('click', () => {
            if(isEditMode) document.getElementById('input-avatar').click();
        });

        // 3. Guardar Datos en Firebase
        saveProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if(!user) return;

            saveProfileBtn.textContent = "‚è≥ Guardando...";

            try {
                // Actualizar los textos en Firestore
                const docRef = doc(db, "periodistas", user.uid);
                await updateDoc(docRef, {
                    nombreCompleto: userName.textContent.trim(),
                    medioComunicacion: userMedia.textContent.trim(),
                    biografia: userBio.textContent.trim()
                });

                // Salir del modo edici√≥n
                isEditMode = false;
                document.body.classList.remove('edit-mode-active');
                
                // Deshabilitar textos
                userName.contentEditable = "false";
                userMedia.contentEditable = "false";
                userBio.contentEditable = "false";
                
                // Restaurar bot√≥n Guardar a su estado original (oculto)
                saveProfileBtn.classList.add('hidden');
                saveProfileBtn.textContent = "üíæ Guardar";

                alert("¬°Perfil actualizado correctamente!");

            } catch (error) {
                console.error("Error al actualizar perfil:", error);
                alert("Hubo un error al guardar los datos.");
                saveProfileBtn.textContent = "üíæ Guardar";
            }
        });


        // --- L√ìGICA DEL MODAL DE CERRAR SESI√ìN ---
        const logoutModal = document.getElementById('logoutModal');

        document.getElementById('logoutBtn').addEventListener('click', () => {
            document.getElementById('dropdownMenu').classList.add('hidden');
            logoutModal.classList.remove('hidden');
        });

        document.getElementById('cancelLogoutBtn').addEventListener('click', () => {
            logoutModal.classList.add('hidden');
        });

        document.getElementById('confirmLogoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
            });
        });

        logoutModal.addEventListener('click', (e) => {
            if (e.target === logoutModal) {
                logoutModal.classList.add('hidden');
            }
        });
    </script>

    <script>
        // Funci√≥n para previsualizar las im√°genes en pantalla
        function updateImg(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById(imgId).src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        // L√≥gica para abrir/cerrar el men√∫ de 3 puntos
        const menuToggle = document.getElementById('menuToggle');
        const dropdownMenu = document.getElementById('dropdownMenu');

        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation(); 
            dropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!dropdownMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
    </script>
</body>

</html>